########################################################
# Work in progress - this does not work yet. 
########################################################


common_permissions: &permissions
  permissions:
    - level: CAN_VIEW
      group_name: users

resources:
  jobs:
    data_ingestion_job:
      parameters:
        - name: bundle_root
          default: ${workspace.file_path}
      name: ${bundle.target}-BrickBrain-data-ingestion-job
      tasks:
        - task_key: VideoDataIngest
          notebook_task:
            notebook_path: ../data_prep/video_data/notebooks/DataIngestion.py
            base_parameters:

              # git source information of current ML resource deployment. It will be persisted as part of the workflow run
              git_source_info: url:${bundle.git.origin_url}; branch:${bundle.git.branch}; commit:${bundle.git.commit}
          environment_key: XYZ_requirements

        - task_key: VideoDataProcessing
          depends_on:
            - task_key: VideoDataIngest
          notebook_task:
            notebook_path: ../data_prep/video_data/notebooks/DataProcessing.py
            base_parameters:
              # git source information of current ML resource deployment. It will be persisted as part of the workflow run
              git_source_info: url:${bundle.git.origin_url}; branch:${bundle.git.branch}; commit:${bundle.git.commit}
          environment_key: data_prep_requirements

        - task_key: BlogDataIngest
          notebook_task:
            notebook_path: ../data_prep/blog_data/notebooks/DataIngestion.py
            base_parameters:
              # git source information of current ML resource deployment. It will be persisted as part of the workflow run
              git_source_info: url:${bundle.git.origin_url}; branch:${bundle.git.branch}; commit:${bundle.git.commit}
          environment_key: data_prep_requirements

        - task_key: BlogDataProcessing
          depends_on:
            - task_key: BlogDataIngest
          notebook_task:
            notebook_path: ../data_prep/blog_data/notebooks/blog_scraper_notebook.py
            base_parameters:
              # git source information of current ML resource deployment. It will be persisted as part of the workflow run
              git_source_info: url:${bundle.git.origin_url}; branch:${bundle.git.branch}; commit:${bundle.git.commit}
          environment_key: data_prep_requirements
      <<: *permissions
        
      environments:
        - environment_key: data_prep_requirements
          spec:
            client: "3"
            dependencies: 
              - "-r /Workspace/Users/${workspace.current_user.userName}/.bundle/${bundle.name}/${bundle.target}/files/data_preparation/data_prep_requirements.txt"

