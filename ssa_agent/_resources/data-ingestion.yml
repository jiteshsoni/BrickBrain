# BrickBrain Databricks Asset Bundle Configuration

# Common permissions template
common_permissions: &permissions
  permissions:
    - level: CAN_VIEW
      group_name: users

resources:
  jobs:
    data_ingestion_job:
      name: ${bundle.target}-BrickBrain-data-ingestion
      <<: *permissions
      
      tasks:
        - task_key: BlogDataIngestion
          notebook_task:
            notebook_path: ../agent/retriever_tool/data_ingestion/blog_data/notebooks/DataIngestion.py
            base_parameters:
              bundle_root: ${workspace.file_path}
              websites: ${var.blog_websites}
              raw_blog_content_table: ${var.uc_catalog}.${var.schema}.raw_blog_content
              preprocessed_blogs_table: ${var.uc_catalog}.${var.schema}.preprocessed_blogs
              chunk_size: ${var.chunk_size}
              chunk_overlap: ${var.chunk_overlap}
              git_source_info: "url:${bundle.git.origin_url}; branch:${bundle.git.branch}; commit:${bundle.git.commit}"

        - task_key: VideoDataIngestion
          notebook_task:
            notebook_path: ../agent/retriever_tool/data_ingestion/video_data/notebooks/DataIngestion.py
            base_parameters:
              bundle_root: ${workspace.file_path}
              channel_name: ${var.youtube_channel}
              max_videos: ${var.max_videos}
              max_workers: 5 
              raw_youtube_content_table: ${var.uc_catalog}.${var.schema}.raw_youtube_content
              preprocessed_youtube_content_table: ${var.uc_catalog}.${var.schema}.preprocessed_youtube_content
              git_source_info: "url:${bundle.git.origin_url}; branch:${bundle.git.branch}; commit:${bundle.git.commit}"

        - task_key: VectorSearchIngestion
          depends_on:
              - task_key: BlogDataIngestion
              - task_key: VideoDataIngestion
          notebook_task:
            notebook_path: ../agent/retriever_tool/vector_search/notebooks/VectorSearchIngestion.py
            base_parameters:
              vector_search_endpoint: ${var.vector_search_endpoint}
              vector_search_index: ${var.uc_catalog}.${var.schema}.brickbrain_index
              preprocessed_data_table: ${var.uc_catalog}.${var.schema}.brickbrain_delta_table
              source_tables: "${var.uc_catalog}.${var.schema}.preprocessed_blogs,${var.uc_catalog}.${var.schema}.preprocessed_youtube_content"
              git_source_info: "url:${bundle.git.origin_url}; branch:${bundle.git.branch}; commit:${bundle.git.commit}"